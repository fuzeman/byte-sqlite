dist: trusty
sudo: false
language: python

python:
  - 2.7
  - 3.6
  - pypy-5.4.1
  - pypy3.3-5.2-alpha1
  - 2.6
  - 3.3
  - 3.4
  - 3.5
  - nightly

before_install:
  - cd $HOME
  - mkdir bin
  - export PATH=$HOME/bin:$PATH
  - "if [[ $TRAVIS_PYTHON_VERSION == 'pypy-5.4.1' ]]; then deactivate && wget https://bitbucket.org/squeaky/portable-pypy/downloads/pypy-5.7-linux_x86_64-portable.tar.bz2 && tar -jxvf pypy-5.7-linux_x86_64-portable.tar.bz2 && echo 'Setting up aliases...' && export PATH=$HOME/pypy-5.7-linux_x86_64-portable/bin/:$PATH && ln -s ~/pypy-5.7-linux_x86_64-portable/bin/pypy ~/bin/python && echo 'Setting up pip...' && pypy-5.7-linux_x86_64-portable/bin/pypy -m ensurepip ; fi"
  - "if [[ $TRAVIS_PYTHON_VERSION == 'pypy3.3-5.2-alpha1' ]]; then deactivate && wget https://bitbucket.org/squeaky/portable-pypy/downloads/pypy3.5-5.7-beta-linux_x86_64-portable.tar.bz2 && tar -jxvf pypy3.5-5.7-beta-linux_x86_64-portable.tar.bz2 && echo 'Setting up aliases...' && export PATH=$HOME/pypy3.5-5.7-beta-linux_x86_64-portable/bin/:$PATH && ln -s ~/pypy3.5-5.7-beta-linux_x86_64-portable/bin/pypy3.3 ~/bin/python && echo 'Setting up pip...' && pypy3.5-5.7-beta-linux_x86_64-portable/bin/pypy -m ensurepip && ln -s ~/pypy3.5-5.7-beta-linux_x86_64-portable/bin/pip3.5 ~/bin/pip ; fi"
  - cd $TRAVIS_BUILD_DIR
install:
  - travis_retry pip install --upgrade coveralls setuptools tox-travis wheel
  - if [[ $TRAVIS_PYTHON_VERSION != 'pypy'* ]]; then travis_retry pip install pyOpenSSL>=16.2.0; fi
script:
  - tox
  - if [[ $TRAVIS_PYTHON_VERSION != 'pypy3*' ]]; then
      python setup.py bdist_wheel sdist;
    else
      python setup.py sdist;
    fi
after_success:
  - coveralls

jobs:
  include:
    - stage: lint
      python: 2.7

      install: travis_retry pip install tox
      script: tox -e flake8
      after_success: true
